<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<dom-module id="wiki-main">
  <style>
    #drawer-content {
      padding: 8px;
    }
    #drawer {
    }
    #search > paper-input {
      color: white;
    }
    paper-item {
      padding: 0 24px;
    }
  </style>
  <template>
    <iron-ajax id="dropdown_search" url="{{searchUrl}}" method="GET" on-response="receivedSearchResponse"></iron-ajax>
    <paper-drawer-panel drawer-width="350px">
      <paper-header-panel id="drawer" drawer>
        <div id="drawer-content">
          <div id="search">
            <paper-input placeholder="Search" value="{{currentSearch}}"></paper-input>
            <template is="dom-if" if="{{hasRecentSearches(searchData)}}">
              <paper-item on-tap="toggleMenu" toggleTarget="search-results">Recent Searches</paper-item>
              <iron-collapse>
                <paper-menu id="search-results">
                  <template is="dom-repeat" items="{{searchData}}">
                    <template is="dom-if" if="{{trim(index, 10)}}">
                      <paper-item>{{index}} - {{item}}</paper-item>
                    </template>
                  </template>
                </paper-menu>
              </iron-collapse>
            </template>
          </div>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
      is: 'wiki-main',
      properties: {
        searchData: {
          type: Array,
          value: [

          ]
        },
        recentSearches: {
          type: Array,
          value: [

          ]
        },
        currentSearch: {
          type: String,
          observer: "doLiveSearch"
        },
        activeArticle: {
          type: Number,
          value: -1,
          observer: "articleChanged"
        },
        searchUrl: {
          type: String,
          computed: 'computeSearchUrl(currentSearch)'
        }
      },
      receivedSearchResponse: function(e, data) {
        var res = data.response;
        this.set("searchData", res);
      },
      articleChanged: function(cur, old) {
        console.log(arguments);
      },
      trim: function(index, limit) {
        return index < limit;
      },
      hasRecentSearches: function(searches) {
        return searches && searches.length > 0;
      },
      // Assumes next element is the menu to toggle!
      toggleMenu: function(e) {
        var nextEl = e.target.nextElementSibling;
        console.log(nextEl);
        if(nextEl) {
          nextEl.toggle();
        }
      },
      doLiveSearch: function() {
        if(this.currentSearch == "" || !this.currentSearch) {
          return console.log("nope this isn't happening");
        }
        console.log("starting ajax request", this.$.dropdown_search);
        this.set("searchData", []);
        this.$.dropdown_search.generateRequest();

      },
      computeSearchUrl: function(q) {
        console.log("generating search url");
        return `/search?q=${q}`;
      }
    })
  </script>
</dom-module>
